# AutoParts - Система парсинга автозапчастей

Система для парсинга брендов автозапчастей с сайтов Autopiter, Armtek и Emex с поддержкой прокси.

## Минимальные требования к серверу

- **ОС:** Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **CPU:** 1 ядро
- **RAM:** 2 ГБ
- **Диск:** 10 ГБ свободного места
- **Docker:** 20.10+
- **Docker Compose:** 2.0+

## Возможности

- ✅ Парсинг брендов с Autopiter.ru
- ✅ Парсинг брендов с Armtek.ru (через API, HTTP и Selenium)
- ✅ Парсинг брендов с Emex.ru
- ✅ Поддержка прокси с автоматической ротацией
- ✅ Веб-интерфейс для управления прокси
- ✅ Обработка больших файлов Excel
- ✅ Реальное время обновления прогресса
- ✅ Автоматическая очистка процессов Chrome

## Исправленные проблемы

### ✅ Selenium ошибки
- Уникальные user-data-dir для каждого запуска Chrome
- Улучшенная очистка процессов Chrome
- Дополнительные опции Chrome для стабильности

### ✅ Неправильный парсинг Autopiter
- Улучшенная фильтрация результатов
- Исключение нерелевантных брендов
- Правильное извлечение брендов из JSON данных

### ✅ Неполная обработка файлов
- Оптимизированные таймауты (60 минут максимум)
- Улучшена обработка ошибок
- Экономия ресурсов для серверов с ограниченной памятью

### ✅ Поддержка прокси
- Автоматическая загрузка из файла proxies.txt
- Ротация прокси между запросами
- Веб-интерфейс для управления прокси

## Запуск системы

### 1. Запуск Docker
Убедитесь, что Docker и Docker Compose установлены и запущены.

### 2. Запуск системы
```bash
docker compose up -d --build
```

### 3. Проверка статуса
```bash
docker compose ps
```

## Использование

### 1. Загрузка файла
- Откройте http://localhost в браузере
- Загрузите Excel файл с колонками: Бренд, Артикул, Наименование, Кросс-номера

### 2. Управление прокси
- Откройте http://localhost/proxy-manager
- Загрузите файл с прокси в формате .txt
- Формат прокси: `ip:port@login:password` или `ip:port`

### 3. Мониторинг прогресса
- Откройте http://localhost/tasks
- Следите за прогрессом обработки в реальном времени

## Структура файлов

```
AutoParts/
├── backend/
│   ├── api/
│   │   ├── autopiter_parser.py  # Основной парсер
│   │   ├── tasks.py             # Celery задачи
│   │   ├── views.py             # API endpoints
│   │   └── urls.py              # URL маршруты
│   ├── Dockerfile               # Docker образ backend
│   └── requirements.txt         # Python зависимости
├── frontend/
│   └── proxy-manager.html       # Интерфейс управления прокси
├── nginx/
│   └── nginx.conf              # Конфигурация nginx
├── docker-compose.yml          # Docker Compose конфигурация
├── proxies.txt                 # Файл с прокси (создается автоматически)
└── README.md                   # Этот файл
```

## API Endpoints

### Парсинг
- `GET /api/parsing-tasks/` - Список задач
- `POST /api/parsing-tasks/create/` - Создать задачу
- `GET /api/parsing-tasks/{id}/` - Статус задачи
- `DELETE /api/parsing-tasks/{id}/delete/` - Удалить задачу

### Прокси
- `POST /api/proxies/upload/` - Загрузить прокси
- `GET /api/proxies/status/` - Статус прокси
- `POST /api/proxies/reset/` - Сбросить индекс прокси

## Формат файла прокси

Создайте файл `proxies.txt` в корне проекта:

```
# С аутентификацией
192.168.1.100:8080@user1:pass1
10.0.0.1:3128@user2:pass2

# Без аутентификации
172.16.0.1:8080
192.168.0.1:3128
```

## Формат Excel файла

Файл должен содержать следующие колонки:
- **Бренд** - оригинальный бренд
- **Артикул** - номер детали
- **Наименование** - описание детали
- **Кросс-номера** - дополнительные номера (опционально)

## Результаты

Система создает отдельные Excel файлы для каждого сайта:
- `autopiter_results_{task_id}.xlsx`
- `armtek_results_{task_id}.xlsx`
- `emex_results_{task_id}.xlsx`

## Мониторинг логов

```bash
# Логи всех сервисов
docker compose logs -f

# Логи только celery
docker compose logs -f celery

# Логи только backend
docker compose logs -f backend
```

## Устранение неполадок

### Проблема: Docker не запускается
**Решение:** Убедитесь, что Docker и Docker Compose установлены и работают корректно.

### Проблема: Недостаточно памяти
**Решение:** 
- Увеличьте swap файл: `sudo fallocate -l 2G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile`
- Добавьте в /etc/fstab: `/swapfile none swap sw 0 0`

### Проблема: Selenium ошибки
**Решение:** Система автоматически очищает процессы Chrome. Если проблемы продолжаются, перезапустите celery:
```bash
docker compose restart celery
```

### Проблема: Медленная обработка
**Решение:** 
- Добавьте больше прокси
- Увеличьте ресурсы в docker-compose.yml (если позволяет сервер)
- Проверьте стабильность интернет-соединения

### Проблема: Не все артикулы обрабатываются
**Решение:** 
- Увеличьте таймауты в tasks.py
- Добавьте больше памяти для celery
- Проверьте логи на наличие ошибок

## Технические детали

### Ресурсы системы (оптимизировано для 2GB RAM)
- **Backend:** 256MB RAM, 0.3 CPU
- **Celery:** 1GB RAM, 0.8 CPU
- **Database:** PostgreSQL 15
- **Cache:** Redis 7

### Таймауты
- **Общий таймаут задачи:** 60 минут
- **Мягкий таймаут:** 50 минут
- **Таймаут HTTP запросов:** 20 секунд
- **Таймаут Selenium:** 30 секунд

### Прокси
- Автоматическая ротация между запросами
- Поддержка аутентификации
- Обработка ошибок прокси
- Fallback на прямые запросы

## Обновления

### v2.1 (текущая версия)
- ✅ Оптимизация для серверов с ограниченными ресурсами
- ✅ Исправлены Selenium ошибки
- ✅ Улучшен парсинг Autopiter
- ✅ Добавлена поддержка прокси
- ✅ Оптимизированы таймауты
- ✅ Улучшена обработка ошибок
- ✅ Добавлен веб-интерфейс управления прокси

## Поддержка

При возникновении проблем:
1. Проверьте логи: `docker compose logs`
2. Убедитесь, что все сервисы запущены: `docker compose ps`
3. Перезапустите систему: `docker compose restart`
4. Проверьте ресурсы системы и интернет-соединение